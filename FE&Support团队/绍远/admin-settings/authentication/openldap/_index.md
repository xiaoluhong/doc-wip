---
标题: 配置 OpenLDAP
---

自v2.0.5起开始可用

如果您的组织使用LDAP进行用户身份验证，则可以配置Rancher与OpenLDAP服务器通信以对用户进行身份验证。这使Rancher管理员可以根据组织中央用户存储库中外部管理的用户和组来控制对集群和项目的访问，同时允许最终用户在登录Rancher UI时使用其LDAP凭据进行身份验证。
### OpenLDAP认证流程

1. 当用户尝试使用其LDAP凭据登录时，Rancher会使用具有搜索目录和读取用户/组属性权限的服务帐户，创建与LDAP服务器的初始绑定。
2. 然后，Rancher使用搜索过滤器根据提供的用户名和配置的属性映射为用户搜索目录。
3. 找到用户后，将使用用户的DN和提供的密码通过另一个LDAP绑定请求对他进行身份验证。  
4. 身份验证成功后，Rancher然后从用户对象的成员资格属性以及通过基于配置的用户映射属性执行组搜索来解析组成员资格。  

> **注意:**
>
> 在进行配置之前，请熟悉 [外部身份认证和主体用户概念](/docs/admin-settings/authentication/#external-authentication-configuration-and-principal-users).

### 先决条件

必须为Rancher配置LDAP绑定帐户（即服务帐户），以搜索和检索与应具有访问权限的用户和组有关的LDAP条目。建议不要为此目的使用管理员帐户或个人帐户，而应在OpenLDAP中创建一个专用帐户，该帐户对配置的搜索基础下的用户和组具有只读访问权限（请参见下文）。


> **使用 TLS?**
>
> 如果OpenLDAP服务器使用的证书是自签名的，或者不是来自公认的证书颁发机构的，则请确保手头有PEM格式的CA证书（与任何中间证书结合）。在配置过程中，您将必须粘贴此证书，以便Rancher能够验证证书链。

### 配置步骤

#### 打开OpenLDAP配置

1. 使用初始本地`admin`帐户登录Rancher UI 
2. 在`全局`视图中，导航至`安全` > `身份验证`
3. 选择 **OpenLDAP**. The **配置OpenLDAP服务**将显示表单.

#### 配置OpenLDAP服务器设置

在标题为的部分中 `1. 配置OpenLDAP服务`, 填写包含服务器特定信息的字段。有关每个参数所需值的详细信息，请参阅下表。

> **注意:**
> 如果您不确定在用户/组“搜索库”配置字段中输入的正确值，请咨询LDAP管理员，或参阅Active Directory身份验证文档中的 [使用ldapsearch识别搜索库和架构部分](/docs/admin-settings/authentication/ad/#annex-identify-search-base-and-schema-using-ldapsearch)。

**表 1: OpenLDAP服务器参数**

| 参数                          | 描述                                                                                                                                                                                                                  |
| :--------------------------------- | :--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 主机名                           | 指定OpenLDAP服务器的主机名或IP地址                                                                                                                                                                   |
| 端口                               | 指定OpenLDAP服务器侦听连接的端口。未加密的LDAP通常使用标准端口389，而LDAPS使用端口636。                                                             |
| TLS                                | 选中此框以启用基于SSL / TLS的LDAP（通常称为LDAPS）。如果服务器使用自签名/企业签名的证书，则还需要粘贴CA证书。                                     |
| 服务器连接超时	        | Rancher在考虑服务器不可达之前等待的持续时间（以秒为单位）。unreachable.                                                                                                                              |
| 服务帐户专有名称	| 输入应用于绑定，搜索和检索LDAP条目的用户的专有名称（DN）。 (查看 [参考](#先决条件)).                                                                          |
| 服务帐号密码	         | 服务帐户的密码.                                                                                                                                                                                        |
| 用户搜索库	                   | 输入目录树中节点的专有名称，从该节点开始搜索用户对象。所有用户都必须是此基本DN的后代。例如：“ ou = people，dc = acme，dc = com”。                      |
| 组搜索基础	                 | 如果您的组所在的节点与在其下配置的节点不同`User Search Base`，则需要在此处提供专有名称。否则将此字段留空。例如：“ ou = groups，dc = acme，dc = com”。 |

---

#### 配置用户/组架构


如果您的OpenLDAP目录偏离标准OpenLDAP架构，则必须完成**定制架构**部分以使其匹配。请注意，Rancher使用本节中配置的属性映射来构造搜索过滤器并解析组成员身份。因此，始终建议您验证此处的配置是否与您的OpenLDAP中使用的架构匹配。

> **注意:**
>
> 如果您不熟悉OpenLDAP服务器中使用的用户/组架构，请咨询LDAP管理员，或参阅Active Directory身份验证文档中的 [使用ldapsearch识别搜索库和架构部分](/docs/admin-settings/authentication/ad/#annex-identify-search-base-and-schema-using-ldapsearch).

##### 用户架构

下表详细介绍了用户架构配置的参数。

**表 2: 用户架构配置参数**

| 参数               | 描述                                                                                                                                                                                                                                                                     |
| :---------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| 对象类           | 域中用于用户对象的对象类的名称。如果定义，则仅指定对象类的名称- 请勿将其包含在LDAP包装器中，例如＆（objectClass = xxxx）                                                                                    |
| 用户名属性	    | 用户属性，其值适合作为显示名称。                                                                                                                                                                                                                 |
| 登录属性	        | 	该属性的值与用户登录Rancher时输入的凭据的用户名部分匹配。通常是这样`uid`。                                                                                                                                   |
| 用户成员属性	   |包含用户所属组的专有名称的用户属性。通常这是`memberOf`或之一`isMemberOf`。                                                                                                                                          |
| 搜索属性	       | 当用户输入文本以在UI中添加用户或组时，Rancher会查询LDAP服务器并尝试通过此设置中提供的属性来匹配用户。可以通过使用竖线("\|")分隔多个属性来指定多个属性。|
| 用户启用的属性	 |如果您的OpenLDAP服务器的架构支持用户属性，可以对其值进行评估以确定该帐户是禁用还是锁定，请输入该属性的名称。默认的OpenLDAP模式不支持此功能，并且该字段通常应留空。 
| 禁用状态位掩码	| 这是禁用/锁定的用户帐户的值。如果`User Enabled Attribute`为空，则忽略该参数。       |

---

##### 组架构配置参数

The table below details the parameters for the group schema configuration.

**Table 3: Group schema configuration parameters**

| 参数                      | 描述                                                                                                                                                                                                    |
| :----------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 对象类别	                 | 域中用于组条目的对象类的名称。如果定义，则仅指定对象类的名称- 请勿将其包含在LDAP包装器中，例如＆（objectClass = xxxx）                 |
| 名称属性	                | 其值适合于显示名称的组属性。                                                                    |
| 组成员用户属性	   | **用户属性的名称**，其格式与中的组成员匹配`Group Member Mapping Attribute`。
| 组成员映射属性	| 包含组成员的组属性的名称。                                                                                        |
| 搜索属性	              | 在向UI中的集群或项目添加组时用于构造搜索过滤器的属性。请参阅用户架构说明`Search Attribute`.                                             |
| 组DN属性	            | 组属性的名称，其格式与用户的组成员资格属性中的值匹配。请参阅`User Member Attribute`.             |
| 嵌套组成员	       | 此设置定义Rancher是否应解析嵌套的组成员身份。仅当您的组织使用这些嵌套成员身份时才使用（即，您具有包含其他组作为成员的组）。 |

---

#### 测试认证


完成配置后，继续测试与OpenLDAP服务器的连接。如果测试成功，则将隐式启用OpenLDAP身份验证。


> **注意:**
>
> 与在此步骤中输入的凭据有关的OpenLDAP用户将映射到本地主体帐户，并在Rancher中分配管理员权限。因此，您应该明智地决定要使用哪个LDAP帐户来执行此步骤。

1. 输入应该映射到本地主体帐户的OpenLDAP帐户的**用户名**和**密码**。
2. 单击**使用OpenLDAP**进行**身份验证**以测试OpenLDAP连接并完成设置。

**结果:**

- 已配置OpenLDAP身份验证。
- 与输入的凭证有关的LDAP用户被映射到本地主体（管理）帐户。

> **注意:**
>
> 如果adminLDAP服务中断，您仍然可以使用本地配置的帐户和密码登录.

### 故障排除

如果在测试与OpenLDAP服务器的连接时遇到问题，请首先仔细检查为服务帐户输入的凭据以及搜索库配置。您也可以检查Rancher日志以帮助查明问题原因。调试日志可能包含有关该错误的更多详细信息。请参阅本文档中的 [如何启用调试日志记录。](/docs/faq/technical/#how-can-i-enable-debug-logging)。
